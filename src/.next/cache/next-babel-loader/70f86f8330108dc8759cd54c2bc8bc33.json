{"ast":null,"code":"import { MongoClient } from 'mongodb';\nimport nextConnect from 'next-connect'; // const client = new MongoClient('mongodb://localhost:27017', {\n//   useNewUrlParser: true,\n//   useUnifiedTopology: true,\n// })\n\nlet mongoClient = null;\nconst url = 'mongodb://localhost:27017';\nconst dbName = 'tezt'; // MongoClient.connect(url, function (err, client) {\n//   console.log('Connected successfully to server')\n//   mongoClient = client\n//   const db = client.db(dbName)\n//   client.close()\n// })\n// async function database(req, res, next) {\n//   // if (!client.isConnected()) await client.connect()\n//   // req.dbClient = client\n//   // req.db = client.db('tezt')\n//   req.db = mongoClient.db('tezt')\n//   console.log(mongoClient)\n//   return next()\n// }\n\nconst client = new MongoClient(process.env.MONGODB_URI, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true\n});\nexport async function setUpDb(db) {\n  await db.collection('tokens').createIndex('expireAt', {\n    expireAfterSeconds: 0\n  });\n}\n\nasync function database(req, res, next) {\n  console.log('fndjsfk', process.env.DB_NAME);\n  if (!client.isConnected()) await client.connect();\n  req.dbClient = client;\n  req.db = client.db(process.env.DB_NAME);\n  await setUpDb(req.db);\n  return next();\n}\n\nconst middleware = nextConnect();\nmiddleware.use(database);\nexport default middleware;","map":null,"metadata":{},"sourceType":"module"}