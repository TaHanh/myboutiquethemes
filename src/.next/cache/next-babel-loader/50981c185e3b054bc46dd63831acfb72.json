{"ast":null,"code":"import React from \"react\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport WysiwygEditor from \"../../../components/wysiwyg-editor\";\nimport Layout from \"../../../components/layout\";\nimport { useState, useEffect } from \"react\";\nimport Axios from \"axios\";\nimport { uploadCallback } from \"../../../utils/upload\";\nimport config from \"../../../config\";\nimport MultiSelect from \"@khanacademy/react-multi-select\";\nimport { toast } from \"react-toastify\";\nimport \"react-toastify/dist/ReactToastify.css\";\nimport { getInitialDataAside } from \"../../../store/data\";\nimport Router from \"next/router\";\nimport Cookies from \"universal-cookie\";\n\nfunction AdPostDetail(props) {\n  const {\n    0: imgSrc,\n    1: setImg\n  } = useState(\"\");\n  const {\n    0: isLoad,\n    1: setLoad\n  } = useState(false);\n  const {\n    0: file,\n    1: setFile\n  } = useState(\"\");\n  const {\n    0: tags,\n    1: setTag\n  } = useState(\"\");\n  const refFile = React.createRef();\n  const {\n    0: data,\n    1: setData\n  } = useState({\n    title: \"\",\n    content: \"\",\n    description: \"\",\n    viewCount: 0,\n    image: \"\",\n    idCategory: \"\",\n    idCreator: \"5eb91ac9be4f1e373075d1b3\",\n    tags: [],\n    compositions: []\n  });\n  const {\n    0: optionComposition,\n    1: setoptionComposition\n  } = useState([]);\n  const {\n    0: selectedCompos,\n    1: setSelectedCompos\n  } = useState([]); // console.log(props.data);\n\n  useEffect(() => {\n    console.log(props.data);\n\n    if (props.isData) {\n      const compos = props.compositions.map(item => {\n        return _objectSpread({}, item, {\n          label: item.name,\n          value: item.id\n        });\n      });\n      setoptionComposition(compos);\n\n      if (props.data.id) {\n        setData(props.data);\n        setTag(props.data.tags.join(\",\"));\n        setImg(config.host.base + props.data.image);\n      } else if (data.idCategory == \"\" && props.categories.length > 0) {\n        data.idCategory = props.categories[0].id;\n        setData(data);\n      }\n    }\n  }, []);\n\n  const changeImg = file => {\n    // var reader = new FileReader()\n    // reader.readAsDataURL(file)\n    // reader.onloadend = function (e) {\n    //   setImg(reader.result)\n    // }.bind(this)\n    setImg(URL.createObjectURL(file));\n    setFile(file);\n  };\n\n  const callBack = (key, value) => {\n    let newData = {};\n    let newTags = [];\n\n    switch (key) {\n      case \"EDITOR\":\n        setData(_objectSpread({}, data, {\n          content: value\n        }));\n        break;\n\n      case \"POST\":\n        newTags = tags.split(\",\").filter((item, index) => {\n          return item != \"\";\n        });\n        newData = _objectSpread({}, data, {\n          tags: newTags\n        });\n        setData(newData);\n        console.log(newData);\n\n        if (file == \"\") {\n          toast.error(\"Bạn chưa đăng ảnh bài viết !\", {\n            autoClose: 3000\n          });\n          console.log(\"file\");\n        } else if (newData.title == \"\" || newData.content == \"\" || newData.description == \"\" || newData.compositions.length == 0 || newData.tags.length == 0) {\n          console.log(\"key\");\n          toast.error(\"Bạn phải nhập đầy đủ thông tin !\", {\n            autoClose: 3000\n          });\n        } else {\n          console.log(newData);\n          post(newData);\n        }\n\n        break;\n\n      case \"UPDATE\":\n        newTags = tags.split(\",\").filter((item, index) => {\n          return item != \"\";\n        });\n        newData = _objectSpread({}, value, {\n          tags: newTags\n        });\n        setData(newData);\n\n        if (newData.title == \"\" || newData.content == \"\" || newData.description == \"\" || newData.compositions.length == 0 || newData.tags.length == 0) {\n          console.log(\"key\");\n          toast.error(\"Bạn phải nhập đầy đủ thông tin !\", {\n            autoClose: 3000\n          });\n        } else {\n          console.log(newData);\n          setLoad(true);\n\n          if (file != \"\") {\n            let image = \"\";\n            uploadCallback(file).then(res => {\n              console.log(res);\n              image = res.imageLink;\n            }).then(() => {\n              let dataaa = _objectSpread({}, newData, {\n                image: image\n              });\n\n              setData(dataaa);\n              update(dataaa).then(r => {\n                setLoad(false);\n              });\n            }).catch(err => {\n              toast.error(\"Đăng ảnh bài viết không thành công !\", {\n                autoClose: 3000\n              });\n              console.log(\"err\", err);\n            });\n          } else {\n            update(newData).then(r => {\n              setLoad(false);\n            });\n          }\n        }\n\n        break;\n\n      case \"DELETE\":\n        Axios.delete(config.host.base + config.path.base.posts + \"/\" + value.id, {\n          headers: {\n            \"Content-Type\": \"application/json\",\n            Authorization: \"Bearer \" + new Cookies().get(\"user\").token\n          }\n        }).then(res => {\n          console.log(res);\n          toast.success(\"Xoá bài viết thành công!\", {\n            autoClose: 3000\n          });\n          setTimeout(() => {\n            Router.back();\n          }, 4000);\n        }).catch(e => {\n          toast.error(\"Xoá bài viết không thành công !\", {\n            autoClose: 3000\n          });\n          console.log(\"Error: \", e);\n        });\n        break;\n\n      default:\n        break;\n    }\n  };\n\n  const post = value => {\n    console.log(file);\n    let image = \"\";\n    setLoad(true);\n    uploadCallback(file).then(res => {\n      console.log(res);\n      image = res.imageLink;\n    }).then(() => {\n      let dataa = _objectSpread({}, value, {\n        image: image\n      });\n\n      setData(dataa);\n      Axios.post(config.host.base + config.path.base.posts, dataa, {\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: \"Bearer \" + new Cookies().get(\"user\").token\n        }\n      }).then(res2 => {\n        console.log(res2);\n        toast.success(\"Thêm bài thành công!\", {\n          autoClose: 3000\n        });\n      }).catch(e => {\n        toast.error(\"Đăng bài không thành công !\", {\n          autoClose: 3000\n        });\n        console.log(\"Error: \", e);\n      }).finally(fil => {\n        setLoad(false);\n      });\n    }).catch(err => {\n      toast.error(\"Đăng ảnh bài viết không thành công !\", {\n        autoClose: 3000\n      });\n      console.log(\"err\", err);\n    });\n  };\n\n  const update = async value => {\n    await Axios.put(config.host.base + config.path.base.posts + \"/\" + value.id, value, {\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: \"Bearer \" + new Cookies().get(\"user\").token\n      }\n    }).then(res => {\n      console.log(res);\n      toast.success(\"Cập nhật bài thành công!\", {\n        autoClose: 3000\n      });\n    }).catch(e => {\n      toast.error(\"Cập nhật bài không thành công !\", {\n        autoClose: 3000\n      });\n      console.log(\"Error: \", e);\n    });\n  };\n\n  return __jsx(Layout, {\n    title: \"Blush\"\n  }, props.isData ? __jsx(\"div\", {\n    className: \"post px-md-4 px-3\"\n  }, __jsx(\"div\", {\n    className: \"pt-5 pb-md-3 pb-3\"\n  }, __jsx(\"div\", {\n    className: \"row\"\n  }, __jsx(\"div\", {\n    className: \"col-md-8\"\n  }, __jsx(\"div\", {\n    className: \"mb-3\"\n  }, __jsx(\"h5\", null, \"Ti\\xEAu \\u0111\\u1EC1\"), __jsx(\"input\", {\n    type: \"text\",\n    className: \"form-control\",\n    multiple: true,\n    value: data.title,\n    onChange: e => {\n      setData(_objectSpread({}, data, {\n        title: e.target.value\n      }));\n    }\n  })), __jsx(\"div\", {\n    className: \"mb-3\"\n  }, __jsx(\"h5\", null, \"M\\xF4 t\\u1EA3 ng\\u1EAFn\"), __jsx(\"input\", {\n    type: \"text\",\n    className: \"form-control\",\n    multiple: true,\n    value: data.description,\n    onChange: e => {\n      setData(_objectSpread({}, data, {\n        description: e.target.value\n      }));\n    }\n  }))), __jsx(\"div\", {\n    className: \"col-md-4\"\n  }, __jsx(\"div\", {\n    className: \"post-image\"\n  }, __jsx(\"input\", {\n    ref: refFile,\n    type: \"file\",\n    onChange: e => changeImg(e.target.files[0]),\n    className: \"d-none\"\n  }), __jsx(\"div\", {\n    className: \"border border-secondary post-image-container\"\n  }, imgSrc ? __jsx(\"img\", {\n    src: imgSrc,\n    style: {\n      objectFit: \"cover\"\n    },\n    className: \"w-100 h-100\"\n  }) : __jsx(\"p\", null, \"\\u1EA2nh b\\xE0i vi\\u1EBFt\"), __jsx(\"button\", {\n    className: \"btn btn-outline-danger post-image-btn\",\n    onClick: () => {\n      refFile.current.click();\n    }\n  }, __jsx(\"i\", {\n    className: \"fas fa-upload\"\n  }))))))), __jsx(\"div\", {\n    className: \"row justify-content-between\"\n  }, __jsx(\"div\", {\n    className: \"col-8\"\n  }, __jsx(\"div\", {\n    className: \"form-group mb-3\"\n  }, __jsx(\"h5\", {\n    for: \"exampleFormControlSelect1\"\n  }, \"Danh m\\u1EE5c\"), __jsx(\"select\", {\n    className: \"form-control\",\n    onChange: e => {\n      console.log(e.target.value);\n      setData(_objectSpread({}, data, {\n        idCategory: e.target.value\n      }));\n    }\n  }, props.categories && props.categories.map((item, index) => {\n    return __jsx(\"option\", {\n      value: item.id,\n      selected: data.idCategory == props.categories[index].id ? true : false\n    }, item.name);\n  })))), __jsx(\"div\", {\n    className: \"col-8\"\n  }, __jsx(\"div\", {\n    className: \"post-compos mb-3\"\n  }, __jsx(\"h5\", null, \"Th\\xE0nh ph\\u1EA7n\"), __jsx(MultiSelect, {\n    options: optionComposition,\n    selected: data.compositions,\n    onSelectedChanged: selected => {\n      setData(_objectSpread({}, data, {\n        compositions: selected\n      }));\n    },\n    overrideStrings: {\n      selectSomeItems: \"Chọn ít nhất một thành phần...\",\n      allItemsAreSelected: \"Tất cả được chọn\",\n      selectAll: \"Chọn tất cả\",\n      search: \"Tìm kiếm\"\n    }\n  })))), __jsx(\"div\", {\n    className: \"row\"\n  }, __jsx(\"div\", {\n    className: \"col-12\"\n  }, __jsx(\"div\", {\n    className: \"mb-3\"\n  }, __jsx(\"h5\", null, \"Tags\"), __jsx(\"div\", {\n    className: \"tags row mx-0 mb-3\"\n  }, __jsx(\"span\", null, \"C\\xF3 th\\u1EC3 ch\\u1ECDn th\\u1EBB tags c\\xF3 s\\u1EB5n: \"), props.tags && props.tags.map((t, i) => {\n    return __jsx(\"button\", {\n      type: \"button\",\n      className: \"badge  btn-outline-primary ml-3\",\n      onClick: () => {\n        let newTags = \"\";\n\n        if (tags != \"\") {\n          newTags = tags + \",\" + t;\n        } else {\n          newTags = t;\n        }\n\n        setTag(newTags);\n      }\n    }, t);\n  })), __jsx(\"input\", {\n    type: \"text\",\n    className: \"form-control\",\n    multiple: true,\n    placeholder: \"V\\xED d\\u1EE5 nh\\u1EADp tags: M\\u1EE5n,D\\u1EA7u,Da Kh\\xF4\",\n    value: tags,\n    onChange: e => {\n      setTag(e.target.value);\n    }\n  })))), __jsx(\"div\", null, __jsx(\"h5\", {\n    className: \"mb-3\"\n  }, \"N\\u1ED9i dung b\\xE0i vi\\u1EBFt\"), __jsx(WysiwygEditor, {\n    callBack: callBack,\n    content: props.data.content\n  })), __jsx(\"div\", {\n    className: \" pt-5 mx-0\"\n  }, isLoad ? __jsx(\"div\", {\n    className: \"row justify-content-center\"\n  }, __jsx(\"div\", {\n    className: \"spinner-border text-primary\",\n    role: \"status\"\n  }, __jsx(\"span\", {\n    className: \"sr-only\"\n  }, \"Loading...\"))) : data.id ? __jsx(\"div\", {\n    className: \"row justify-content-between mx-0\"\n  }, __jsx(\"button\", {\n    type: \"button\",\n    className: \"btn btn-danger text-uppercase font-weight-bold\",\n    onClick: () => callBack(\"DELETE\", data)\n  }, \"Xo\\xE1 b\\xE0i vi\\u1EBFt\"), __jsx(\"button\", {\n    type: \"button\",\n    className: \"btn btn-primary text-uppercase font-weight-bold\",\n    onClick: () => callBack(\"UPDATE\", data)\n  }, \"C\\u1EADp nh\\u1EADt b\\xE0i vi\\u1EBFt\")) : __jsx(\"div\", {\n    className: \"row justify-content-center\"\n  }, __jsx(\"button\", {\n    type: \"button\",\n    className: \"btn btn-danger text-uppercase font-weight-bold\",\n    onClick: () => callBack(\"POST\", data)\n  }, \"\\u0110\\u0103ng b\\xE0i\")))) : __jsx(\"div\", {\n    className: \"pt-5\"\n  }, __jsx(\"h4\", null, \"Hi\\u1EC7n t\\u1EA1i h\\u1EC7 th\\u1ED1ng \\u0111ang l\\u1ED7i !\")));\n}\n\nAdPostDetail.getInitialProps = async function (ctx) {\n  const {\n    req,\n    res,\n    query\n  } = ctx;\n  const cookies = new Cookies();\n  let user = cookies.get(\"user\");\n\n  if (user) {\n    let dataPost = {};\n    let tags = {};\n    let resTag = await Axios.get(config.host.base + config.path.base.tags).catch(e => {\n      console.log(\"Error: \", e.code);\n    });\n    tags = resTag && resTag.data != undefined ? resTag.data : [];\n\n    if (query.id) {\n      let resPost = await Axios.get(config.host.base + config.path.base.posts + \"/\" + query.id).catch(e => {\n        console.log(\"Error: \", e.response);\n        res.redirect(config.client.adminPostDetail);\n      });\n      dataPost = resPost && resPost.data != undefined ? resPost.data : [];\n    }\n\n    const dataa = await getInitialDataAside();\n\n    if (dataa.categories.length == 0 && dataa.compositions.length == 0) {\n      return {\n        isData: false\n      };\n    }\n\n    return _objectSpread({}, dataa, {\n      isData: true,\n      data: dataPost,\n      tags: tags\n    });\n  } else {\n    res.redirect(\"/\");\n  }\n\n  return;\n};\n\nexport default AdPostDetail;","map":null,"metadata":{},"sourceType":"module"}